<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>تحويل الكلام لأرقام (مدعّم لهجات)</title>
  <style>
    body{font-family:Tahoma, Arial;direction:rtl;padding:20px;background:#111;color:#eee}
    button{padding:10px 16px;border-radius:8px;border:none;cursor:pointer;margin:6px}
    #startBtn{background:#4CAF50;color:#fff}
    #stopBtn{background:#f44336;color:#fff}
    #outputBox{margin-top:12px;background:#222;padding:12px;border-radius:8px;border:1px solid #333;min-height:60px}
  </style>
</head>
<body>
  <h2>اختبار تحويل الأرقام باللهجة</h2>
  <button id="startBtn">▶︎ بدء التسجيل</button>
  <button id="stopBtn">✖ إيقاف</button>
  <div id="outputBox">النتيجة ستظهر هنا</div>

<script>
/* ===== دالة تحويل الكلمات إلى أرقام (مع تطبيع لهجات) ===== */
function wordsToNumbersInText(text){
  if(!text || !text.trim()) return text;

  // 1) تطبيع أحرف شائعة
  text = text.toLowerCase();
  text = text.replace(/[إأآ]/g,"ا");
  text = text.replace(/ى/g,"ي");
  text = text.replace(/ؤ/g,"و");
  text = text.replace(/ئ/g,"ي");
  text = text.replace(/ة/g,"ة"); // نترك التاء المربوطة
  text = text.replace(/[.,؛،!؟]/g," ");
  text = text.replace(/\s+/g," ").trim();

  // 2) استبدال عبارات مكوّنة من كلمتين إلى كلمة واحدة (حتى نساويها في الخريطة)
  const multiMap = {
    "احد عشر":"احد_عشر","احدى عشر":"احدى_عشر",
    "اثنا عشر":"اثنا_عشر","اثني عشر":"اثنا_عشر","اثنا عشر":"اثنا_عشر",
    "ثلاثة عشر":"ثلاثة_عشر","ثلاث عشر":"ثلاثة_عشر",
    "اربعة عشر":"اربعة_عشر","اربعة عشر":"اربعة_عشر",
    "خمسة عشر":"خمسة_عشر","ستة عشر":"ستة_عشر",
    "سبعة عشر":"سبعة_عشر","ثمانية عشر":"ثمانية_عشر","تسعة عشر":"تسعة_عشر"
  };
  Object.keys(multiMap).forEach(k=>{
    const re = new RegExp("\\b"+k+"\\b","g");
    text = text.replace(re, multiMap[k]);
  });

  // 3) استبدالات سريعة للالتقاط اللهجي (نوعاً ما شاملة)
  const variantMap = {
    // مئات لهجات/أخطاء شائعة => نطابق مفردة موجودة في hundreds map
    "ميه":"مية","ميّة":"مية","ميه":"مية","ميه":"مية",
    "تسعميه":"تسعمية","تسعماية":"تسعمية","تسعمية":"تسعمية",
    "تسعم":"تسعمية",
    "سبعميه":"سبعمية","سبعماية":"سبعمية",
    "ستميه":"ستمية","ستم":"ستمية",
    "ثمنميه":"ثمانمية","تمنمية":"ثمانمية","اثمنميه":"ثمانمية","اثمنمية":"ثمانمية",
    "ثمانميه":"ثمانمية","ثمانمية":"ثمانمية",
    "تلاته":"ثلاثة","تلات":"ثلاثة","تلت":"ثلاثة",
    "تمنيه":"ثمانية","تمانية":"ثمانية",
    // كلمات اخرى ممكن يقرأها ASR
    "الفين":"الفين","الفين":"الفين"
  };
  Object.keys(variantMap).forEach(k=>{
    const re = new RegExp("\\b"+k+"\\b","g");
    text = text.replace(re, variantMap[k]);
  });

  // 4) ماب القيم (شامل لهجات/صياغات)
  const units = {
    "صفر":0,"واحد":1,"واحدة":1,"احد":1,"احدى":1,
    "اثنان":2,"اثنين":2,"اتنين":2,"اثنتان":2,"اثنتين":2,"ثنين":2,
    "ثلاثة":3,"ثلاث":3,"تلاتة":3,"تلاته":3,
    "اربعة":4,"اربع":4,
    "خمسة":5,"خمس":5,
    "ستة":6,"ست":6,
    "سبعة":7,"سبع":7,
    "ثمانية":8,"ثمان":8,"تمانية":8,"تمنيه":8,"ثمنيه":8,
    "تسعة":9,"تسع":9
  };

  const teens = {
    "احد_عشر":11,"احدى_عشر":11,"اثنا_عشر":12,"ثلاثة_عشر":13,"اربعة_عشر":14,
    "خمسة_عشر":15,"ستة_عشر":16,"سبعة_عشر":17,"ثمانية_عشر":18,"تسعة_عشر":19,
    "عشرة":10,"عشر":10
  };

  const tens = {
    "عشرون":20,"عشرين":20,"ثلاثون":30,"ثلاثين":30,"تلاتين":30,
    "اربعون":40,"اربعين":40,"خمسون":50,"خمسين":50,
    "ستون":60,"ستين":60,"سبعون":70,"سبعين":70,
    "ثمانون":80,"ثمانين":80,"تسعون":90,"تسعين":90
  };

  const hundreds = {
    "مائة":100,"مئة":100,"مية":100,"ميه":100,
    "مئتين":200,"ميتين":200,
    "ثلاثمائة":300,"ثلاثمية":300,"ثلاثمية":300,
    "اربعمائة":400,"اربعمية":400,"اربعماية":400,
    "خمسمائة":500,"خمسمية":500,"خمسماية":500,
    "ستمائة":600,"ستمية":600,"ستمية":600,
    "سبعمائة":700,"سبعمية":700,"سبعمية":700,
    "ثمانمائة":800,"ثمانمية":800,"تمنمية":800,"ثمنمية":800,"تمنمية":800,
    "تسعمائة":900,"تسعمية":900
  };

  const multipliers = {
    "ألف":1000,"الف":1000,"الفين":2000,"ألفين":2000,"آلاف":1000,
    "مليون":1000000,"ملايين":1000000,
    "مليار":1000000000,"مليارات":1000000000
  };

  const allWords = Object.assign({}, units, teens, tens, hundreds, multipliers);

  // 5) تفكيك إلى كلمات مع إزالة الواو الملتصقة مثل "وثمانين" -> "ثمانين"
  let rawTokens = text.split(/\s+/).map(t=>{
    // إذا كانت الكلمة لها وملتصقة في بدايتها، نزيل الواو الالتصاقية
    return t.replace(/^و(?=[\u0621-\u064A])/,'');
  });

  // 6) بناء النتيجة: نحتفظ بما هو نص ونحوّل مجموعات الأرقام إلى قيمة رقمية
  let resultParts = [];
  let buffer = [];

  function flushBuffer(){
    if(buffer.length===0) return null;
    let total = 0, current = 0;
    buffer.forEach(w=>{
      if(teens[w]!==undefined){
        current += teens[w];
      } else if(units[w]!==undefined){
        current += units[w];
      } else if(tens[w]!==undefined){
        current += tens[w];
      } else if(hundreds[w]!==undefined){
        current += hundreds[w];
      } else if(multipliers[w]!==undefined){
        let m = multipliers[w];
        if(current === 0) current = 1;
        current = current * m;
        total += current;
        current = 0;
      } else {
        // كلمة غير معروفة داخل البافر -> نتجاهلها كرقم
      }
    });
    total += current;
    buffer = [];
    return total;
  }

  for(let i=0;i<rawTokens.length;i++){
    const w = rawTokens[i];
    if(allWords[w]!==undefined){
      buffer.push(w);
    } else {
      const n = flushBuffer();
      if(n!==null){
        resultParts.push(String(n));
      }
      resultParts.push(w);
    }
  }
  const lastNum = flushBuffer();
  if(lastNum!==null) resultParts.push(String(lastNum));

  // إعادة دمج النتيجة كسلسلة (نترك المسافات بين الكلمات)
  return resultParts.join(" ");
}



/* ===== محرك الصوت (webkitSpeechRecognition) ===== */
let recognition;
if(!("webkitSpeechRecognition" in window)){
  document.getElementById('outputBox').innerText = "هذا المتصفح لا يدعم webkitSpeechRecognition. استخدم Chrome.";
} else {
  recognition = new webkitSpeechRecognition();
  recognition.lang = "ar-IQ"; // لهجة عراقية
  recognition.interimResults = false;
  recognition.continuous = false;

  recognition.onstart = function(){
    document.getElementById('outputBox').innerText = "🎙️ جاري الاستماع... قل جملة تحتوي أرقاماً باللهجة";
  };

  recognition.onresult = function(ev){
    const transcript = ev.results[0][0].transcript.trim();
    const converted = wordsToNumbersInText(transcript);
    document.getElementById('outputBox').innerHTML = "<b>النص:</b> "+transcript+"<br><b>بعد التحويل:</b> "+converted;
    console.log("transcript:",transcript,"converted:",converted);
  };

  recognition.onerror = function(e){
    console.error(e);
    document.getElementById('outputBox').innerText = "حدث خطأ: "+ (e.error || "unknown");
  };

  recognition.onend = function(){
    // لا نفعل شيء خاص عند الانتهاء (يمكن إعادة البدء بالضغط)
  };
}

/* ===== ربط الأزرار ===== */
document.getElementById('startBtn').addEventListener('click', ()=>{
  if(recognition) recognition.start();
});
document.getElementById('stopBtn').addEventListener('click', ()=>{
  if(recognition) recognition.stop();
});
</script>
</body>
</html>
