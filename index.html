<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>نسخ التاريخ</title>
<style>
  body{font-family:"Tahoma";background:#111;color:#fff;text-align:center}
  .container{margin-top:20px}
  #output{margin:10px;padding:10px;border:1px solid #555;min-height:40px}
  #history{border:1px solid #888;margin:20px auto;padding:10px;width:80%;height:auto;max-height:300px;overflow-y:auto;display:flex;flex-direction:column;gap:5px}
  .btn{padding:6px 12px;margin:5px;cursor:pointer;border:none;border-radius:8px}
  #copyAllBtn{background:#2a2}
  #toggleOrientation{background:#28a}
  #stopBtn{background:#a22;display:none}
</style>
</head>
<body>
<div class="container">
  <button id="startBtn" class="btn">🎤 بدء</button>
  <button id="stopBtn" class="btn">⏹ إيقاف</button>
  <button id="copyAllBtn" class="btn">📋 نسخ الكل</button>
  <button id="toggleOrientation" class="btn">↔ تحويل</button>
  <div id="recordingIndicator" style="display:none;color:red">🔴 تسجيل...</div>
  <div id="output"></div>
  <div id="history"></div>
</div>

<script>
let recognition;
let isHorizontal=false;

function wordsToNumbersInText(text){
  const units={"صفر":0,"واحد":1,"واحدة":1,"اثنان":2,"اثنين":2,"ثلاثة":3,"ثلاث":3,"اربعة":4,"أربعة":4,"خمسة":5,"ستة":6,"سبعة":7,"ثمانية":8,"تسعة":9};
  const teens={"عشرة":10,"احدى عشر":11,"إحدى عشر":11,"اثنا عشر":12,"إثنا عشر":12,"ثلاثة عشر":13,"اربعة عشر":14,"أربعة عشر":14,"خمسة عشر":15,"ستة عشر":16,"سبعة عشر":17,"ثمانية عشر":18,"تسعة عشر":19};
  const tens={"عشرون":20,"عشرين":20,"ثلاثون":30,"ثلاثين":30,"اربعون":40,"أربعون":40,"اربعين":40,"أربعين":40,"خمسون":50,"خمسين":50,"ستون":60,"ستين":60,"سبعون":70,"سبعين":70,"ثمانون":80,"ثمانين":80,"تسعون":90,"تسعين":90};
  const hundreds={"مائة":100,"مئة":100,"مية":100,"مئتين":200,"ميتين":200,"ثلاثمائة":300,"ثلاثمية":300,"أربعمائة":400,"اربعماية":400,"خمسمائة":500,"خمسماية":500,"ستمائة":600,"ستمية":600,"سبعمائة":700,"سبعمية":700,"ثمانمائة":800,"ثمانمية":800,"تسعمائة":900,"تسعمية":900};
  const multipliers={"ألف":1000,"الف":1000,"ألفين":2000,"الفين":2000,"آلاف":1000,"مليون":1000000,"ملايين":1000000};
  const allWords=Object.assign({},units,teens,tens,hundreds,multipliers);

  const tokens=text.replace(/،/g," ").replace(/ و /g," ").trim().split(/\s+/);
  let resultWords=[]; let numberBuffer=[];

  function processBuffer(buffer){
    let total=0; let current=0;
    buffer.forEach(word=>{
      if(teens[word]!==undefined) current+=teens[word];
      else if(units[word]!==undefined) current+=units[word];
      else if(tens[word]!==undefined) current+=tens[word];
      else if(hundreds[word]!==undefined) current+=hundreds[word];
      else if(multipliers[word]!==undefined){
        if(multipliers[word]>=1000){
          current=(current===0?1:current)*multipliers[word];
          total+=current;current=0;
        } else current*=multipliers[word];
      }
    });
    total+=current;
    return total.toString();
  }

  for(let i=0;i<tokens.length;i++){
    const word=tokens[i];
    const twoWords=word+" "+(tokens[i+1]||"");
    if(teens[twoWords]){numberBuffer.push(twoWords);i++;continue;}
    if(allWords[word]) numberBuffer.push(word);
    else {
      if(numberBuffer.length>0){
        resultWords.push(processBuffer(numberBuffer));
        numberBuffer=[];
      }
      resultWords.push(word);
    }
  }
  if(numberBuffer.length>0) resultWords.push(processBuffer(numberBuffer));
  return resultWords.join(" ");
}

function startRecognition(){
  const SpeechRecognition=window.webkitSpeechRecognition;
  if(!SpeechRecognition){alert("❌ هذه الميزة تعمل فقط على متصفح Chrome.");return;}
  recognition=new SpeechRecognition();
  recognition.lang='ar-IQ';
  recognition.interimResults=false;
  recognition.onstart=function(){
    document.getElementById("recordingIndicator").style.display="block";
    document.getElementById("startBtn").style.display="none";
    document.getElementById("stopBtn").style.display="inline-block";
  }
  recognition.onresult=function(event){
    const transcript=event.results[0][0].transcript;
    const converted=wordsToNumbersInText(transcript);
    document.getElementById("output").innerText=converted;
    addHistoryLine(converted,true);
  }
  recognition.onend=function(){
    document.getElementById("recordingIndicator").style.display="none";
    document.getElementById("startBtn").style.display="inline-block";
    document.getElementById("stopBtn").style.display="none";
  }
  recognition.start();
}
function stopRecognition(){if(recognition) recognition.stop();}

// === history ===
const historyDiv=document.getElementById("history");

function addHistoryLine(text,isAuto=false){
  const div=document.createElement("div");
  div.style.position="relative";
  div.style.paddingLeft="10px";
  div.style.cursor="pointer";
  div.style.direction="rtl";     // النصوص العربية من اليمين
  div.style.unicodeBidi="plaintext"; // الأرقام من اليسار

  // النص نفسه
  const span=document.createElement("span");
  span.textContent=text;
  div.appendChild(span);

  div.onclick=function(){
    navigator.clipboard.writeText(span.textContent);
    const notif=document.createElement("span");
    notif.textContent="✔ تم النسخ";
    notif.style.position="absolute";
    notif.style.left="-90px";
    notif.style.top="0";
    notif.style.color="#0f0";
    div.appendChild(notif);
    setTimeout(()=>notif.remove(),1500);
  };

  historyDiv.appendChild(div);
  historyDiv.scrollTop=historyDiv.scrollHeight;

  if(isAuto){
    navigator.clipboard.writeText(span.textContent);
  }
}

// === نسخ الكل ===
document.getElementById("copyAllBtn").onclick=function(){
  const allText=[...historyDiv.children].map(c=>c.querySelector("span").textContent).join("\n");
  navigator.clipboard.writeText(allText);
}

// === تحويل عمودي/أفقي ===
document.getElementById("toggleOrientation").onclick=function(){
  isHorizontal=!isHorizontal;
  historyDiv.style.display="flex";
  historyDiv.style.flexDirection=isHorizontal?"row":"column";
  historyDiv.style.flexWrap=isHorizontal?"wrap":"nowrap";
}
</script>
</body>
</html>
