<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Convert audio</title>
  <style>
    /* == التنسيقات تبعك نفسها بالضبط، ما غيرت شيء == */
    body {
      margin: 0;
      padding: 0;
      background-color: #000;
      color: #fff;
      font-family: Tahoma, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
    }
    /* باقي الـ CSS كما هو ... */
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDa1_gisk5GuTvRzACp0lA1TGe3-b2Sz8A",
      authDomain: "dragon-tv-3e8c1.firebaseapp.com",
      databaseURL: "https://dragon-tv-3e8c1-default-rtdb.firebaseio.com",
      projectId: "dragon-tv-3e8c1",
      storageBucket: "dragon-tv-3e8c1.firebasestorage.app",
      messagingSenderId: "909817368695",
      appId: "1:909817368695:web:b5e9ffccafefcbc41a7672"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>
</head>
<body>
  <!-- نفس HTML تبعك بالضبط -->
  <div class="login-container" id="login">
    ...
  </div>

  <div class="container" id="app">
    ...
  </div>

  <script>
    /* نفس الدوال تبعك بدون أي تغيير (base64EncodeUnicode, updateUserOnlineStatus, checkLogin, logout ...) */
  </script>

  <!-- التعرف الصوتي -->
  <script>
    let recognition;

    function wordsToNumbersInText(text) {
      /* نفس دالتك الأصلية تبع تحويل الكلمات لأرقام، ما غيرت فيها */
      const units = {"صفر":0,"واحد":1,"واحدة":1,"احد":1,"احدى":1,"اثنان":2,"اثنين":2,"اثنتان":2,"اثنتين":2,"ثنين":2,"ثلاثة":3,"ثلاث":3,"أربعة":4,"اربعة":4,"اربع":4,"خمسة":5,"خمس":5,"ستة":6,"ست":6,"سبعة":7,"سبع":7,"ثمانية":8,"ثمان":8,"تسعة":9,"تسع":9};
      const teens = {"عشرة":10,"عشر":10,"أحد عشر":11,"احد عشر":11,"احدى عشر":11,"اثنا عشر":12,"اثني عشر":12,"ثلاثة عشر":13,"ثلاث عشر":13,"أربعة عشر":14,"اربعة عشر":14,"خمسة عشر":15,"ستة عشر":16,"سبعة عشر":17,"ثمانية عشر":18,"تسعة عشر":19};
      const tens = {"عشرون":20,"عشرين":20,"ثلاثون":30,"ثلاثين":30,"أربعون":40,"اربعين":40,"خمسون":50,"خمسين":50,"ستون":60,"ستين":60,"سبعون":70,"سبعين":70,"ثمانون":80,"ثمانين":80,"تسعون":90,"تسعين":90};
      const hundreds = {"مائة":100,"مئة":100,"مية":100,"مئتين":200,"ميتين":200,"ثلاثمائة":300,"ثلاثمية":300,"أربعمائة":400,"اربعماية":400,"خمسمائة":500,"خمسماية":500,"ستمائة":600,"ستمية":600,"سبعمائة":700,"سبعمية":700,"ثمانمائة":800,"ثمانمية":800,"تسعمائة":900,"تسعمية":900};
      const multipliers = {"ألف":1000,"الف":1000,"ألفين":2000,"الفين":2000,"آلاف":1000,"مليون":1000000,"ملايين":1000000};

      const allWords = Object.assign({}, units, teens, tens, hundreds, multipliers);
      const tokens = text.replace(/،/g," ").replace(/ و /g," ").trim().split(/\s+/);

      let resultWords = [];
      let numberBuffer = [];

      function processBuffer(buffer) {
        let total = 0, current = 0;
        buffer.forEach(word => {
          if (teens[word] !== undefined) current += teens[word];
          else if (units[word] !== undefined) current += units[word];
          else if (tens[word] !== undefined) current += tens[word];
          else if (hundreds[word] !== undefined) current += hundreds[word];
          else if (multipliers[word] !== undefined) {
            if (multipliers[word] >= 1000) {
              current = (current === 0 ? 1 : current) * multipliers[word];
              total += current;
              current = 0;
            } else {
              current *= multipliers[word];
            }
          }
        });
        total += current;
        return total;
      }

      for (let i = 0; i < tokens.length; i++) {
        const word = tokens[i];
        const twoWords = word + " " + (tokens[i+1] || "");
        if (teens[twoWords]) {
          numberBuffer.push(twoWords);
          i++;
          continue;
        }

        if (allWords[word]) {
          numberBuffer.push(word);
        } else {
          if (numberBuffer.length > 0) {
            const num = processBuffer(numberBuffer);
            if (num !== null) resultWords.push(num.toString());
            numberBuffer = [];
          }
          resultWords.push(word);
        }
      }

      if (numberBuffer.length > 0) {
        const num = processBuffer(numberBuffer);
        if (num !== null) resultWords.push(num.toString());
      }

      return resultWords.join(" ");
    }

    // 🚀 الدالة الجديدة للتواريخ
    function formatArabicDate(text) {
      const months = {
        "يناير": 1, "كانون": 1, "كانون الثاني": 1,
        "فبراير": 2, "شباط": 2,
        "مارس": 3, "آذار": 3,
        "ابريل": 4, "أبريل": 4, "نيسان": 4,
        "مايو": 5, "أيار": 5,
        "يونيو": 6, "حزيران": 6,
        "يوليو": 7, "تموز": 7,
        "اغسطس": 8, "أغسطس": 8, "آب": 8,
        "سبتمبر": 9, "ايلول": 9,
        "أكتوبر": 10, "اكتوبر": 10, "تشرين الأول": 10,
        "نوفمبر": 11, "تشرين الثاني": 11,
        "ديسمبر": 12, "كانون الأول": 12
      };

      let words = text.split(/\s+/);
      let numbers = words.filter(w => !isNaN(w)).map(n => parseInt(n));
      let day = null, month = null, year = null;

      for (let i = 0; i < words.length; i++) {
        if (months[words[i]]) {
          month = months[words[i]];
        }
      }

      if (numbers.length >= 3) {
        year = numbers.find(n => n > 1900);
        if (year) {
          let rest = numbers.filter(n => n !== year);
          if (rest.length >= 2) {
            day = Math.min(...rest);
            month = Math.max(...rest);
          }
        }
      }

      if (numbers.length === 2 && month) {
        day = numbers[0];
        year = numbers[1];
      }

      if (numbers.length === 2 && !month) {
        day = numbers[0];
        month = numbers[1];
      }

      if (!year) {
        for (let n of numbers) {
          if (n > 1900) {
            year = n;
          }
        }
      }

      if (day && month && year) {
        return `${year}/${month.toString().padStart(2,"0")}/${day.toString().padStart(2,"0")}`;
      }

      return text;
    }

    function startRecognition(){
      const SpeechRecognition=window.webkitSpeechRecognition;
      if(!SpeechRecognition){alert("❌ هذه الميزة تعمل فقط على متصفح Chrome.");return;}
      recognition=new SpeechRecognition();
      recognition.lang='ar-IQ';
      recognition.interimResults=false;

      recognition.onstart=function(){
        document.querySelector(".container").classList.add("recording");
        document.getElementById("recordingIndicator").style.display="block";
        document.getElementById("startBtn").style.display="none";
        document.getElementById("stopBtn").style.display="inline-block";
      }

      recognition.onresult=function(event){
        const transcript=event.results[0][0].transcript;
        let converted=wordsToNumbersInText(transcript);
        converted=formatArabicDate(converted); // ✅ إضافة تنسيق التاريخ

        document.getElementById("output").innerText=converted;

        const history=document.getElementById("history");
        history.value += converted + "\n";
        let lines = history.value.split("\n");
        if(lines.length > 10){
          lines = lines.slice(lines.length-10);
          history.value = lines.join("\n");
        }

        navigator.clipboard.writeText(converted).catch(()=>{});
      }

      recognition.onend=function(){
        document.querySelector(".container").classList.remove("recording");
        document.getElementById("recordingIndicator").style.display="none";
        document.getElementById("startBtn").style.display="inline-block";
        document.getElementById("stopBtn").style.display="none";
      }

      recognition.start();
    }

    function stopRecognition(){
      if(recognition){
        recognition.stop();
      }
    }
  </script>
</body>
</html>
