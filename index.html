<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>اختبار — تحويل أرقام من الكلام</title>
<style>
  body{font-family:tahoma, Arial; background:#0b0b0b; color:#eee; display:flex; align-items:center; justify-content:center; min-height:100vh; margin:0; padding:20px}
  .card{background:#111;padding:18px;border-radius:10px; width:100%; max-width:520px; box-shadow:0 6px 24px rgba(0,0,0,0.6)}
  button{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;margin:6px}
  #start{background:#2ecc71;color:#012}
  #stop{background:#e74c3c;color:#fff;display:none}
  #raw,#clean,#result{background:#0f0f0f;padding:10px;border-radius:6px;margin-top:8px;min-height:28px}
  .label{font-size:13px;color:#9a9a9a;margin-top:8px}
  .ltr-num{direction:ltr;unicode-bidi:embed;font-weight:700;color:#9fe}
</style>
</head>
<body>
  <div class="card">
    <h3 style="margin:0 0 8px 0;text-align:center">اختبار تحويل أرقام من الكلام</h3>
    <div style="text-align:center">
      <button id="start">▶ بدء التسجيل</button>
      <button id="stop">■ إيقاف</button>
    </div>

    <div class="label">raw (النص المسموع):</div>
    <div id="raw"></div>

    <div class="label">clean (بعد التنظيف):</div>
    <div id="clean"></div>

    <div class="label">الناتج (سلاسل أرقام كما نطق):</div>
    <div id="result"></div>

    <p style="margin-top:12px;color:#c7c7c7;font-size:13px">
      جرّب: "صفر صفر صفر صفر صفر تلاتة تلاتة تلاتة" أو "خمسمائة خمسمائة"
    </p>
  </div>

<script>
/* ======== دوال الاختبار ======== */
function escapeHtml(s){
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function normalizeRepeats(text){
  if(!text) return "";
  // نظف علامات الترقيم ودمج المسافات — لا نقلص تكرار الكلمات
  return text.replace(/[.,;؟!،\u060C]/g,' ').replace(/\s+/g,' ').trim();
}

function wordsToNumbersInText(text){
  if(!text) return "";
  // تنظيف ابتدائي
  text = String(text).toLowerCase().replace(/[.,;؟!،\u060C]/g,' ').replace(/\s+/g,' ').trim();

  // تصحيحات شائعة (أضف حالات أخرى لو احتجت)
  text = text.replace(/\bخمسمه\b/gi,'خمسمائة')
             .replace(/\bاتلاثه\b/gi,'تلاتة')
             .replace(/\bاتلاث\b/gi,'تلاتة')
             .replace(/\bاتنين\b/gi,'اثنين');

  // خرايط التحويل إلى سلاسل رقمية (نحتفظ بالقيم كسلاسل حتى نلصق بالترتيب)
  const numericMap = {
    "صفر":"0","٠":"0",
    "واحد":"1","واحدة":"1","احد":"1","احدى":"1",
    "اثنان":"2","اثنين":"2","اثنتان":"2","اثنتين":"2","ثنين":"2",
    "ثلاثة":"3","ثلاث":"3","تلاتة":"3","تلات":"3","تلث":"3",
    "اربع":"4","اربعة":"4","أربعة":"4","اربع":"4",
    "خمسة":"5","خمس":"5",
    "ستة":"6","ست":"6",
    "سبعة":"7","سبع":"7",
    "ثمانية":"8","ثمان":"8","ثمن":"8",
    "تسعة":"9","تسع":"9",
    // عشرات/مئات/آلاف نضع تمثيلها كقيم نصية (قد تكون أكثر من رقم واحد)
    "عشرة":"10","عشر":"10",
    "عشرون":"20","عشرين":"20","ثلاثون":"30","ثلاثين":"30","اربعون":"40","اربعين":"40",
    "خمسون":"50","خمسين":"50","ستون":"60","ستين":"60","سبعون":"70","سبعين":"70",
    "ثمانون":"80","ثمانين":"80","تسعون":"90","تسعين":"90",
    "مئة":"100","مائة":"100","مية":"100",
    "مئتين":"200","ميتين":"200",
    "ثلاثمائة":"300","خمسمائة":"500","ستمائة":"600","سبعمائة":"700","ثمانمائة":"800","تسعمائة":"900",
    "الف":"1000","ألف":"1000","الفين":"2000","مليون":"1000000","ملايين":"1000000"
  };

  // فصل التوكنز وفصل 'و' الملصوقة
  let rawTokens = text.split(/\s+/);
  let tokens = [];
  rawTokens.forEach(t=>{
    if(!t) return;
    if(t.length>1 && t[0]==='و'){
      tokens.push('و');
      tokens.push(t.slice(1));
    } else tokens.push(t);
  });

  // نبني الناتج: كل كلمة رقمية تضيف تمثيلها النصي مباشرة إلى numericRun
  let numericRun = "";
  let parts = [];

  tokens.forEach(tok=>{
    if(tok === 'و') return; // نتجاهل حرف العطف
    if(numericMap.hasOwnProperty(tok)){
      numericRun += String(numericMap[tok]);
    } else {
      if(numericRun.length>0){
        parts.push('<span class="ltr-num">'+ numericRun +'</span>');
        numericRun = "";
      }
      // كلمة غير رقمية: نضيفها ككلمة نصية مفصولة بمسافة
      parts.push(" " + escapeHtml(tok));
    }
  });

  if(numericRun.length>0) parts.push('<span class="ltr-num">'+ numericRun +'</span>');

  return parts.join("").trim();
}

/* ======== التعرف الصوتي ======== */
let recognition = null;
const startBtn = document.getElementById('start');
const stopBtn  = document.getElementById('stop');
const rawEl    = document.getElementById('raw');
const cleanEl  = document.getElementById('clean');
const resEl    = document.getElementById('result');

startBtn.addEventListener('click', startRecognition);
stopBtn.addEventListener('click', stopRecognition);

function startRecognition(){
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRecognition){
    alert('الميكروفون الصوتي يتطلب متصفح يدعم SpeechRecognition (Chrome متاح عادة).');
    return;
  }
  recognition = new SpeechRecognition();
  recognition.lang = 'ar-IQ';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onstart = ()=>{
    startBtn.style.display = 'none';
    stopBtn.style.display  = 'inline-block';
    rawEl.textContent = cleanEl.textContent = resEl.textContent = '';
  };

  recognition.onresult = function(event){
    try {
      const transcript = (event.results[0] && event.results[0][0] && event.results[0][0].transcript) ? event.results[0][0].transcript : "";
      rawEl.textContent = transcript;

      let cleaned = normalizeRepeats(transcript);
      cleanEl.textContent = cleaned;

      let converted = wordsToNumbersInText(cleaned);
      resEl.innerHTML = converted || '(لا توجد نتيجة رقمية)';

      console.log('raw:', transcript);
      console.log('clean:', cleaned);
      console.log('converted:', converted);
    } catch(err){
      console.error('onresult error', err);
    }
  };

  recognition.onerror = function(e){
    console.error('recognition error', e);
  };

  recognition.onend = function(){
    startBtn.style.display = 'inline-block';
    stopBtn.style.display  = 'none';
  };

  try { recognition.start(); } catch(e) { console.error(e); alert('فشل بدء التسجيل: '+ e.message); }
}

function stopRecognition(){
  if(recognition) recognition.stop();
}
</script>
</body>
</html>
